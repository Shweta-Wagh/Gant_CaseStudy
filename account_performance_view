WITH orders AS (
  SELECT
    order_id,
    account_id,
    SAFE_CAST(order_date AS DATE) AS order_date,
    SAFE_CAST(order_value AS FLOAT64) AS order_value,
    product_category,
    LOWER(order_status) AS order_status
  FROM `project-cd0b5ae6-aa02-4a42-acb.crm_dataset.order_object`
),

accounts AS (
  SELECT
    account_id,
    account_name,
    channel_type,
    region,
    SAFE_CAST(create_date AS DATE) AS create_date,
    account_status
  FROM `project-cd0b5ae6-aa02-4a42-acb.crm_dataset.account_object`
),

order_flags AS (
  SELECT
    o.*,
    IF(order_status = 'completed', TRUE, FALSE) AS is_completed,
    IF(order_status = 'cancelled', TRUE, FALSE) AS is_cancelled,
    IF(order_status = 'completed', SAFE_CAST(order_value AS FLOAT64), 0.0) AS completed_order_value
  FROM orders o
),

-- Per-account aggregates
acct AS (
  SELECT
    a.account_id,
    a.account_name,
    a.channel_type,
    a.region,
    a.create_date,
    a.account_status,
    oo.product_category,
    COUNT(oo.order_id) AS total_orders,
    SUM(oo.completed_order_value) AS total_completed_revenue,
    SUM(IF(oo.is_cancelled, 1, 0)) AS cancelled_orders,
    MAX(oo.order_date) AS most_recent_order_date,
    COUNT(DISTINCT oo.product_category) AS num_categories_purchased
  FROM accounts a
  LEFT JOIN order_flags oo
    ON a.account_id = oo.account_id
  GROUP BY a.account_id, a.account_name, a.channel_type, a.region, a.create_date, a.account_status, oo.product_category
),

-- Channel-level aggregates to support channel comparison metrics
channel AS (
  SELECT
    a.channel_type,
    COUNT(oo.order_id) AS channel_total_orders,
    SUM(oo.completed_order_value) AS channel_total_completed_revenue,
    SUM(IF(oo.is_cancelled, 1, 0)) AS channel_cancelled_orders,
    AVG(oo.order_value) AS channel_avg_order_value
  FROM order_flags oo
  LEFT JOIN accounts a ON oo.account_id = a.account_id
  GROUP BY a.channel_type
),

overall AS (
  SELECT SUM(channel_total_completed_revenue) AS overall_completed_revenue
  FROM channel
)

SELECT
  acct.account_id,
  acct.account_name,
  acct.channel_type,
  acct.region,
  acct.create_date,
  acct.account_status,
  acct.product_category,

  -- Account KPIs
  COALESCE(acct.total_orders, 0) AS total_orders,
  COALESCE(acct.total_completed_revenue, 0.0) AS total_completed_revenue,
  COALESCE(acct.cancelled_orders, 0) AS cancelled_orders,
  acct.most_recent_order_date,
  COALESCE(acct.num_categories_purchased, 0) AS num_categories_purchased,

  -- Channel KPIs (same values for all accounts in same channel)
  COALESCE(ch.channel_total_orders, 0) AS channel_total_orders,
  COALESCE(ch.channel_total_completed_revenue, 0.0) AS channel_total_completed_revenue,
  COALESCE(ch.channel_cancelled_orders, 0) AS channel_cancelled_orders,
  COALESCE(ch.channel_avg_order_value, 0.0) AS channel_avg_order_value,

  -- Channel comparison metrics
  SAFE_DIVIDE(acct.total_completed_revenue, NULLIF(ch.channel_total_completed_revenue, 0)) AS pct_of_channel_revenue,
  SAFE_DIVIDE(ch.channel_total_completed_revenue, NULLIF(o.overall_completed_revenue, 0)) AS channel_pct_of_total_revenue

FROM acct
LEFT JOIN channel ch
  ON acct.channel_type = ch.channel_type
CROSS JOIN overall o
ORDER BY acct.channel_type, acct.total_completed_revenue DESC;

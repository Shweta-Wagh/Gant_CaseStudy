WITH orders_completed AS (
  SELECT
    o.order_id,
    o.account_id,
    o.order_date,
    o.order_value,
    o.product_category,
    COALESCE(a.channel_type, 'UNKNOWN') AS channel_type
  FROM
    `project-cd0b5ae6-aa02-4a42-acb.crm_dataset.order_object` AS o
  LEFT JOIN
    `project-cd0b5ae6-aa02-4a42-acb.crm_dataset.account_object` AS a
  USING (account_id)
  WHERE
    o.order_status = 'Completed'
),

channel_category AS (
  SELECT
    channel_type,
    product_category,
    COUNT(*) AS total_orders,
    SUM(order_value) AS total_revenue,
    AVG(order_value) AS avg_price
  FROM orders_completed
  GROUP BY channel_type, product_category
),

channel_totals AS (
  SELECT
    channel_type,
    SUM(total_revenue) AS channel_revenue
  FROM channel_category
  GROUP BY channel_type
)

SELECT
  cc.channel_type,
  cc.product_category,
  cc.total_revenue,
  cc.total_orders,
  ROUND(cc.avg_price, 2) AS avg_price,
  ROUND(SAFE_DIVIDE(cc.total_revenue, ct.channel_revenue) * 100, 2) 
      AS pct_of_channel_revenue
FROM channel_category cc
LEFT JOIN channel_totals ct USING (channel_type)
ORDER BY channel_type, total_revenue DESC;
